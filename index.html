<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>
  <div id="calculator-body">
    <div id="display"></div>

    <button id="(">(</button>
    <button id=")">)</button>
    <button id="DEL">DEL</button>
    <button id="AC">AC</button>
    <button id="seven" data-numbers="7">7</button>
    
    <button id="eight" data-numbers="8">8</button>
    <button id="nine" data-numbers="9">9</button>
    <button id="divide" data-operator="÷">÷</button>
    <button id="four" data-numbers="4">4</button>
    <button id="five" data-numbers="5">5</button>
    
    <button id="six" data-numbers="6">6</button>
    <button id="multiply" data-operator="x">x</button>
    <button id="one" data-numbers="1">1</button>
    <button id="two" data-numbers="2">2</button>
    <button id="three" data-numbers="3">3</button>
    
    <button id="subtract" data-operator="-">-</button>
    <button id="zero" data-numbers="0">0</button>
    <button id="decimal">.</button>
    <button id="equal" class="operator">=</button>
    <button id="add"  data-operator="+">+</button>
    

  </div>
</body>
<script src="big.js/big.min.js"></script>
<script>
  const calculatorBody = document.getElementById('calculator-body');
  const digits = document.querySelectorAll('button[data-numbers]');
  const operators = document.querySelectorAll('button[data-operator]');
  const display = document.getElementById('display');
  const equal = document.getElementById('equal');
  const decimal = document.getElementById('decimal');
  const del = document.getElementById('DEL');
  const openingParenthesis = document.getElementById('(');
  const closingParenthesis = document.getElementById(')');
  const allClear = document.getElementById('AC');

  let displayValue = '0';
  updateDisplay(displayValue);

  function add(num1, num2) {
  return num1 + num2;
}

  function subtract(num1, num2) {
  return num1 - num2;
}

  function multiply(num1, num2) {
  return num1 * num2;
}

  function divide(num1, num2) {
  return num1 / num2;
}

  function operate(operator, num1, num2) {
  if (operator == '+') {
    return add(num1, num2)
  } else if (operator == '-') {
    return subtract(num1, num2)
  } else if (operator == 'x') {
    return multiply(num1, num2)
  } else if (operator == '÷') {
    return divide(num1, num2)
  }
}

  function decimalOperate(operator, num1, num2) {
    let sum = 0
    if (operator == '+') {
      num1 = new Big(num1);
      sum = num1.plus(num2)
      return Number(sum.valueOf())
    } 
    else if (operator == '-') {
      num1 = new Big(num1);
      sum = num1.minus(num2)
      return Number(sum.valueOf())
    } 
    else if (operator == 'x') {
      num1 = new Big(num1);
      sum = num1.times(num2)
      return Number(sum.valueOf())
    } 
    else if (operator == '÷') {
      num1 = new Big(num1);
      sum = num1.div(num2)
      return Number(sum.valueOf())
    }
  }

  function isOperator(operator) {
  if (
    operator === '+'
    || operator === '-'
    || operator === 'x'
    || operator === '÷'
  ) {
    return true;
  } else {
    return false;
  }
}

  function isParenthesis(operator) {
  if (operator === '(' || operator == ')') {
    return true;
  } else {
    return false;
  }
}

  function isDecimal(num1) {
  if (num1 % 1 != 0) {
    return true
  } else {
    return false
  }
}

  function isLastOperatorEqualOrBigger(last, cur) {
  // if last operator is Equal or bigger, true
  // if last operator is less, false

  // if last operator is '(', last operator is less
  if (last === '(') {
    return false;
  }
  
  if (cur === last) {
    return true;
  }

  if (cur === '+' || cur === '-') {
    return true;
  } else {
    if (last === 'x' || last === '÷') {
      return true;
    } else {
      return false;
    }
  }
}

  function returnNumbersAndOperators(displayValue) {
  // Parameters
  //     displayValue: string

  // returns an array of numbers and operators in the order
  // This CAN'T handle wrong expressions yet
  // ex) 50 x 50 +  throws an error
  
  if (displayValue.length == 0) {
    return displayValue; // return as is
  } else {
    let displayValueArray = displayValue.split('');
    let currentNumber = '';
    let infixNotationArray = [];

    displayValueArray.forEach((element, index, arr) => {

      if( isNaN(Number(element)) && element != '.' ) {
        // Not a Number or a decimal
      } else if(element == '.') {
        // Decimal
        currentNumber += element;
      } else {
        // Number
        currentNumber += element;
      }

      if(isOperator(element) || isParenthesis(element)) {
        if(currentNumber.length === 0) { // there's no number to push
          infixNotationArray.push(element)
        } else { // there's a number to push
          currentNumber = Number(currentNumber);
          infixNotationArray.push(currentNumber);
          infixNotationArray.push(element);
          currentNumber = '';
        }
      }

      // If it's the end of the array, add the current number to the Numbers
      if(index === arr.length - 1) {
        if (element != ')') {
          currentNumber = Number(currentNumber);
          infixNotationArray.push(currentNumber);
          currentNumber = '';
        }
      }
    });
    
    return infixNotationArray;
  } 
} 

  function infixToPostfix(infixArray) {
  // parameter
  //    infixArray: Array
  
  // Takes an array of infixNotation and returns an array of postfix Notation
  let postfixNotation = [];
  let stack = [];

  infixArray.forEach((element, index, arr) => {
    // 1. if operand, add to the notation
    if (typeof element === 'number') {
      postfixNotation.push(element);
    } 
    
    // 2-1. If operator,
    if (isOperator(element)) {
      // 2.a if stack is empty, just push to the stack
      if(stack.length === 0) { 
        stack.push(element);
      } else { // 2.b if stack is not empty
        let lastOperator = stack[stack.length - 1];
        let currentOperator = element;
        // 2.b.i last operator in stack is equal or bigger than the current
        // operator - pop the last operator from stack, and add to the notation,
        // and push current operator to the stack
        if(isLastOperatorEqualOrBigger(lastOperator, currentOperator)) {
          lastOperator = stack.pop();
          postfixNotation.push(lastOperator);
          stack.push(currentOperator);
        } else {
          // 2.b.ii last operator in stack is less than current operator, push
          // current operator to the stack
          stack.push(currentOperator);
        }
      }
    } // isOperator

    // 2-2 if parenthesis 
    if (isParenthesis(element)) {
      if(element === '(') {
        stack.push(element);
      } else { // closing parenthesis
        
        let stackLength = stack.length;
        for (let i= stackLength - 1; i >= 0; i--) {
          let poppedElem = stack.pop();
          if (poppedElem != '(') {
            postfixNotation.push(poppedElem);
          } else { // if it is '(', finish the loop
            break;
          }
        }  
      }
    }

    // 3. if infix notation ends..
    if(index === arr.length - 1) {
      stackLength = stack.length
      for (let i = 0; i < stackLength; i++) {
        postfixNotation.push(stack.pop());
      }
    } // last element
  }) // forEach


  return postfixNotation;
} 

  function calcPostfix(postfixArray) {
  // parameter
  //    postfixArray: array

  // Takes an array of postfix Notation, and calculates it.
  // and return the result of the calculation. Type of return is 'number'

    let numStack = [];
    for (let i = 0; i < postfixArray.length; i++) {
      let curElem = postfixArray[i];
      if(typeof curElem === 'number') { // operand, push to the stack
        numStack.push(Number(curElem));
      } else { // operator, pop last 2 elements, and do calculatioin regarding
              // to the operator
        let firstNum = 0;
        let secondNum = 0;
        let operator = curElem;
        let result = 0;

        
        secondNum = numStack.pop();
        firstNum = numStack.pop();

        if(isDecimal(firstNum) || isDecimal(secondNum)) { 
          // javascript can't handle specific decimal operations, so I use 
          // big.js
          result = decimalOperate(operator, firstNum, secondNum) 
        } else { 
          // not decimal, we can use basic operations
          result = operate(operator, firstNum, secondNum);
        }
        numStack.push(result);
      }

      // When it's end,
      if(i === postfixArray.length - 1) {
        return numStack[0];
      }
    }
  }
  
  // Displays the value and operators that has been clicked.
  function updateDisplay(displayValue) {
    display.innerHTML = displayValue;
  }

  // Returns the display Value
  function returnDisplay() {
    return display.innerHTML
  }


  // Event Listeners for all digits
  digits.forEach(digit => {
    digit.addEventListener('click', event => {
      if (displayValue == '0') { // when first starting, replace 0 with input
        displayValue = event.target.getAttribute("data-numbers");
      } else {
        displayValue += event.target.getAttribute("data-numbers");
      }
      updateDisplay(displayValue);
    })
  })
  
  // Event Listeners for four basic operators
  operators.forEach(operator => {
    // let displayValueArray = displayValue.split('');
    // let lastElement = displayValueArray[displayValueArray.length -1];
    
    operator.addEventListener('click', event => {
      // Check if your last value is operator
      displayValue += event.target.getAttribute("data-operator");
      updateDisplay(displayValue);
    })
  })

  openingParenthesis.addEventListener('click', event => {
    if (displayValue == '0') { // when first starting, replace 0 with input
      displayValue = '(';
    } else {
      displayValue += '(';
    }
    updateDisplay(displayValue);
  })

  closingParenthesis.addEventListener('click', event => {
    displayValue += ')';
    updateDisplay(displayValue);
  })

  decimal.addEventListener('click', event => {
    displayValue += '.';
    updateDisplay(displayValue);
  })

  del.addEventListener('click', event => {
    let splittedDisplayValue = displayValue.split('');
    splittedDisplayValue.pop();
    displayValue = splittedDisplayValue.join('');
    updateDisplay(displayValue);
  })

  allClear.addEventListener('click', event => {
    displayValue = '0';
    updateDisplay(displayValue);
  })

  // If equal is clicked, calculate the all the numbers regarding the operators
  equal.addEventListener('click', event => {
    let infixArr = returnNumbersAndOperators(displayValue);
    console.log(`infixArr: ${infixArr}`);
    
    let postfixArr = infixToPostfix(infixArr);
    console.log(`postfixArr: ${postfixArr}`);
    
    let result = calcPostfix(postfixArr);
    console.log(`result: ${result}`);
    updateDisplay(result);
    
    
    
    
    

   
    
   
   
  }) // equal.addEventListener

  


</script>

</html>